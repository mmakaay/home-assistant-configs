---
# This automation is based on multiple sensors.
#
# In the shower: IKEA TrÃ¥dfri motion sensr
# This sensor reports "ON" for 1 minute, then "OFF" for 30 seconds when
# detecing motion. The state "ON" is not kept when there is still
# motion going on.
# 
# Outside the shower: AQARA motion sensor
# This sensor reports "ON" as long as there is motion.

- id: badkamer_lamp_A
  alias: "[BADKAMER LICHT] A. zet aan bij beweging"
  description: >
    Lamp aan en de timer (her)starten als er beweging wordt gedetecteerd.
  trigger:
    - entity_id: binary_sensor.badkamer_beweging
      platform: state
      to: 'on'
    - entity_id: binary_sensor.badkamer_spiegel_beweging
      platform: state
      to: 'on'
  action:
    # cancel/start, because of this bug:
    # https://github.com/home-assistant/home-assistant/issues/12013
    - service: timer.cancel
      data:
        entity_id: timer.badkamer
    - service: timer.start
      data_template:
        entity_id: timer.badkamer
        duration: >
          {% if is_state("sensor.periode_van_de_dag", "avond") or
                is_state("sensor.periode_van_de_dag", "nacht") %}
            00:02:00
          {% else %}
            00:05:00
          {% endif %}
    - service: scene.turn_on
      data_template:
        entity_id: >
          scene.badkamer_automatisch_{{ states('sensor.periode_van_de_dag') }}


- id: badkamer_lamp_B
  alias: "[BADKAMER LICHT] B. uitzetten na timeout en geen beweging"
  description: >
    Wanneer de timer afloopt, en er is geen beweging in de ruimte, maak
    dan het licht weer uit.
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.badkamer
  condition:
    - condition: state
      entity_id: binary_sensor.badkamer_beweging
      state: 'off'
    - condition: state
      entity_id: binary_sensor.badkamer_spiegel_beweging
      state: 'off'
  action:
    - service: light.turn_off
      data:
        entity_id: light.badkamer_plafond


- id: badkamer_lamp_C
  alias: "[BADKAMER LICHT] C. herstarten na timeout maar wel beweging"
  description: >
    Wanneer de timer afloopt en er is beweging in de ruimte, herstart dan
    de timer.
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.badkamer
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.badkamer_spiegel_beweging
          state: 'on'
        - condition: state
          entity_id: binary_sensor.badkamer_beweging
          state: 'on'
  action:
    - service: timer.start
      data_template:
        entity_id: timer.badkamer
        duration: >
          {% if is_state("sensor.periode_van_de_dag", "avond") or
                is_state("sensor.periode_van_de_dag", "nacht") %}
            00:02:00
          {% else %}
            00:05:00
          {% endif %}

