---
# This automation is based on the IKEA TrÃ¥dfri motion sensorthat I use in my
# toilet. This sensor reports "ON" for 1 minute, then "OFF" for 30 seconds when
# detecing motion. The state "ON" is not kept when there is still motion going
# on. While this is a bit basic, it does allow for a pretty simple automation.

- id: toilet_licht_A
  alias: "[TOILET LICHT] A. zet aan bij beweging"
  description: >
    Lamp aan en de timer (her)starten als er beweging wordt gedetecteerd.
  trigger:
    - entity_id: binary_sensor.toilet_beweging
      platform: state
      to: 'on'
  condition:
    - condition: state
      entity_id: timer.toilet_cooldown
      state: 'idle'
  action:
    - service: scene.turn_on
      data_template:
        entity_id: >
          scene.toilet_automatisch_{{ states('sensor.periode_van_de_dag') }}
    # cancel/start, because of this bug:
    # https://github.com/home-assistant/home-assistant/issues/12013
    - service: timer.cancel
      data:
        entity_id: timer.toilet
    - service: timer.start
      data_template:
        entity_id: timer.toilet
        duration: 00:10:00

- id: toilet_licht_B
  alias: "[TOILET LICHT] B. verkort timer bij beweging in de gang"
  description: >
    Als de toilet timer actief is, en er wordt beweging gedetecteerd
    in de gang, dan kan het zijn dat iemand van het toilet naar de gang
    is gegaan. In dat geval verlagen we de toilet timer. Dit lijkt een
    redelijke oplossing om de standaard toilet timer niet kort te hoeven
    zetten. De timer wordt niet zo kort gezet dat iemand per direct in
    het donker komt te zitten.
  trigger:
    - entity_id: binary_sensor.gang_beweging
      platform: state
      to: 'on'
  condition:
    - condition: state
      entity_id: timer.toilet
      state: 'active'
  action:
    # cancel/start, because of this bug:
    # https://github.com/home-assistant/home-assistant/issues/12013
    - service: timer.cancel
      data:
        entity_id: timer.toilet
    - service: timer.start
      data_template:
        entity_id: timer.toilet
        duration: 00:03:00

- id: toilet_licht_C
  alias: "[TOILET LICHT] C. zet uit na een tijdje geen beweging"
  description: >
    Wanneer de timer afloopt en er is geen beweging in de ruimte, maak
    dan het licht weer uit. De beweging cooldown timer wordt ook
    uitgezet, omdat we best willen dat na dit event de lampen meteen
    weer aangaan bij beweging.
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.toilet
  action:
    - service: light.turn_off
      data:
        entity_id: light.toilet_plafond
    - wait_template: "{{ is_state('timer.toilet_cooldown', 'active') }}"
      timeout: 5
      continue_on_timeout: 'false'
    - service: timer.cancel
      data:
        entity_id: timer.toilet_cooldown


- id: toilet_licht_D
  alias: "[TOILET LICHT] D. cooldown activeren als het licht uitgaat"
  description: >
    Wanneer de lamp uitgaat op het toilet, dan willen we de bewegingssensor
    even negeren, zodat eventuele beweging niet direct het licht weer aanzet.
    Denk aan het scenario waarbij je met de hand het licht uitmaakt en dan
    wegloopt (wat een beweging is, waarmee je het licht zou kunnen triggeren).
  trigger:
    - entity_id: light.toilet_plafond
      platform: state
      to: 'off'
  action:
    - service: timer.cancel
      data:
        entity_id: timer.toilet
    - service: timer.start
      data:
        entity_id: timer.toilet_cooldown

- id: toilet_licht_E
  alias: "[TOILET LICHT] E. cooldown deactiveren als het licht aangaat"
  description: >
    Wanneer de lamp aangaat op het toilet, dan kan een eventuele cooldown
    timer worden gestopt.
  trigger:
    - entity_id: light.toilet_plafond
      platform: state
      to: 'on'
  action:
    - service: timer.cancel
      data:
        entity_id: timer.toilet_cooldown
